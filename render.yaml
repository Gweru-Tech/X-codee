services:
  # Type: web (default), worker, pserv
  - type: web
    name: xcoder-platform
    env: node
    plan: free
    buildCommand: "npm install --production"
    startCommand: "./start.sh"
    healthCheckPath: "/health"
    healthCheck:
      path: "/health"
      initialDelaySeconds: 60
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 8080
      - key: MONGODB_URI
        sync: false
      - key: SESSION_SECRET
        sync: false
      - key: JWT_SECRET
        sync: false
      - key: STRIPE_PUBLISHABLE_KEY
        sync: false
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: SMTP_HOST
        sync: false
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASS
        sync: false
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false
      - key: AWS_S3_BUCKET
        sync: false
      - key: REDIS_URL
        sync: false
      - key: NPM_CONFIG_PRODUCTION
        value: "false"

  # Background worker for processing jobs
  - type: worker
    name: xcoder-worker
    env: node
    plan: free
    buildCommand: "npm install"
    startCommand: "npm run worker"
    envVars:
      - key: NODE_ENV
        value: production
      - key: MONGODB_URI
        sync: false
      - key: REDIS_URL
        sync: false
      - key: BULL_REDIS_URL
        sync: false

  # MongoDB Database
  - type: pserv
    name: xcoder-mongodb
    env: docker
    plan: free
    repo: https://github.com/render-examples/mongodb.git
    dockerfilePath: ./Dockerfile
    envVars:
      - key: MONGO_INITDB_ROOT_USERNAME
        value: admin
      - key: MONGO_INITDB_ROOT_PASSWORD
        sync: false
      - key: MONGO_INITDB_DATABASE
        value: xcoder-platform

  # Redis Cache
  - type: pserv
    name: xcoder-redis
    env: docker
    plan: free
    repo: https://github.com/render-examples/redis.git
    dockerfilePath: ./Dockerfile
    envVars:
      - key: REDIS_PASSWORD
        sync: false

databases:
  # Alternative: Use Render's managed MongoDB
  - name: xcoder-db
    databaseName: xcoderplatform
    user: xcoder
    plan: free

# Auto-deploy configuration
version: "1"
build:
  artifacts:
    - path: ./dist
      type: directory
    - path: ./uploads
      type: directory

# Health checks
healthChecks:
  - type: startup
    path: /health
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

# Scaling configuration (paid plans)
scaling:
  minInstances: 1
  maxInstances: 3
  targetCPUPercent: 70
  targetMemoryPercent: 80

# Notification settings
notifications:
  email: your-email@example.com
  slack: https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK

# Custom domains (optional)
domains:
  - name: xcoderplatform.com
    type: primary
  - name: www.xcoderplatform.com
    type: secondary

# Environment groups for different stages
environments:
  production:
    services:
      - type: web
        plan: starter
        envVars:
          - key: NODE_ENV
            value: production
          - key: LOG_LEVEL
            value: error
  
  staging:
    services:
      - type: web
        plan: free
        envVars:
          - key: NODE_ENV
            value: staging
          - key: LOG_LEVEL
            value: debug